文件上传漏洞
===

## 1、什么是文件上传漏洞？
关键字：绕过<br>
在开发者没有做充分验证（包括前端、后端）情况下，允许用户上传恶意文件。<br>
这里上传的文件可以是木马、病毒、恶意脚本或WebShell等。<br>

## 2、初探
文件上传功能的防护措施：无<br>

一句话木马：
* 名词解析： 在上传文件时，上传一个包含一句话木马的脚本文件。
* 漏洞利用流程： shell.php文件 -> 内容： <?php @eval($_POST["自定义的字段名"]);?>
* 原理： 可通过POST方式传入一段代码，由eval()函数将这段代码解析成php代码并执行。

## 3、初阶
文件上传功能的防护措施：常规的文件后缀名黑名单（如：禁止上传 .asp .php 等后缀的文件）<br>

后缀名绕过：
* 名词解析：将 shell.php 重命名为 shell.php3 ， 即可绕过黑名单成功上传，并与.php具有相同功能。
* 漏洞利用流程： 将 shell.php 重命名为 shell.php3 并上传
* 原理： 
	* 1、 找到托管当前Web应用的Web服务器的类型； 	--如：Apache2
	* 2、 查看 Apache2 的配置文件，找到不同类型文件的解析器具体是什么；<br>
		* 路径跟踪： apache2.conf -> mods-enabled/*.conf -> mods-enabled/php5.conf<br>

	* 3、 在 php5.conf 文件中，可以看到如下配置： 故 .php .php3 .php4 .php5 .pht .phtml 文件均会被解析器作为php文件解析。
```xml
<FilesMatch ".+\.ph(p[345]?|t|tml)$">
	SetHandler application/x-httpd-php
</FilesMatch>
```

## 4、中阶
1、 前端验证绕过：<br>
* 背景： 很多网站、CMS都有使用，只在前端利用 js 来做校验，而后端不再做校验。
* 漏洞利用流程：
	* 通过 Burp Suite 抓包，然后修改内容后放行。
	* 通过浏览器设置 禁止/删除 js 代码，从而实现 js 校验的失效。

2、 .htaccess绕过<br>
* 前提条件: 文件上传功能没有设置白名单过滤。
* 漏洞利用流程： 
	* 上传 .htaccess 文件， 内容 ： AddType applcation/x-httpd-php .test
	* 上传一句话木马文件，文件名设置为 shell.test
	* 在浏览器中访问 shell.test 即可执行一句话木马

3、 大小写绕过<br>
* 针对黑名单
* 漏洞利用流程：
	* 如 .php 在黑名单中，那么就上传 .pHp .Php ...
* 原理： 与平台有关。
	* window 平台是大小写不敏感的。  .php 与 .pHp 被认为是同一个文件
	* linux 平台默认是大小写敏感的， 以上示例被认为是不同的文件
	* 注： 可以通过在 Linux 平台下的目标应用中加载 speling 模块，使得该目标应用实现大小写不敏感。

## 5、高阶
1、 Windows 文件流特性绕过<br>
* 漏洞利用流程：
	* Echo 111 > test.txt:1.txt 		（将 111 写入到 test.txt 的 1.txt 文件流中）
	* Echo test > test.txt 				（将 test 写入到 test.txt 的默认文件流中）
	* Echo 222 > test.txt::$data 		（将 222 写入到 test.txt 的默认文件流中）
* 原理： 
Windows 的 NTFS 文件系统实现了多文件流特性。NTFS 环境下一个文件默认使用的是未命名的文件流，同时可创建其他命名的文件流。<br>
Windows 资源管理器默认不显式文件的命名文件流，这些命名的文件流在功能上和默认使用的未命名文件流一致，甚至可以用来启动程序。<br>

2、 %00截断绕过<br>
* 针对白名单： 保存文件时通过前端获取的路径拼接的方式。
* 前提条件： 上传者可以分别控制 储存路径 及 文件名称。
* 漏洞利用流程： 在路径上截断。
	* 设置 save_path = ../upload/a.php%00
	* 上传一个内容为一句话木马的jgp文件
* 原理： 通过路径来保存文件，该文件最后会被保存为 a.php （因为 %00 是文件数据流中的结尾符）

3、 文件头检测绕过<br>
* 针对文件内容检测
* 漏洞利用流程：
	* 准备一个 .png 或 .jpg 文件，并保留文件头的内容，其他内容可删掉
	* 将一句话木马文件聚合到上述文件中
	* 将该文件上传
* 原理： 它满足文件头的标准校验，会被认为是一个符合要求的文件。但其中聚合的一句话木马可以被执行。


## 总结：
* 白名单安全性要远远大于黑名单。
* 白名单 + 后台固定存储路径 的方式可以阻止单一的文件上传漏洞的直接攻击。
* 对于漏洞链的防御不足。 
	* 如： 利用文件上传漏洞 上传包含一句话木马的文件，但该一句话木马在此并不会被解析成代码而执行。<br>
		   再利用其它的漏洞，将该一句话木马进行解析并执行，从而实现攻击。<br>

## 防御措施：
* 文件类型检测： 白名单 优于 黑名单
* 使用安全的函数进行编程
* 熟悉业务部署环境的 OS、Web Server 的配置 